[ { "title": "Build a Pritunl Slack Slash Commands with a Serverless Backend", "url": "/posts/build-a-pritunl-slack-slash-commands-with-a-serverless-backend/", "categories": "Pritunl, Enterprise VPN", "tags": "Slack Slash Command, Slack Application, Slack Integration, Serverless, AWS SAM, AWS Lambda Application, Python Library, API Client, Pritunl VPN, OpenVPN, WireGuard, AWS SAM Package Zip, AWS SAM Package Image, Kubernetes, Helm", "date": "2023-04-28 00:00:00 +0800", "content": "Introduction For self-service automation, Slack is one of the leading platforms that it can provide. As DevOps, which also considers company administrators, we ensure team members, such as Developers or QA, are presented with their technical needs without always relying on us. In this post, we will build and deploy a Slack Slash Command for Pritunl Enterprise VPN users so they can generate their VPN Profile and Keys to access the organization’s resources. Quick Demo Figure 1: Pritunl Slack Slash Commands Application Slack App Setup Create a new Slack application Go to Slack API -&gt; Your Apps -&gt; Create New App. Create an app Steps From Create an app pop-up window -&gt; choose From an app manifest. Step 1: Pick a workspace to develop your app Pick a Workspace to develop your app in. Then proceed to next step. Step 2: Enter app manifest below The App manifest contains basic info, scopes, settings, and features. Choose the YAML option, then copy and paste the code provided for you. display_information: name: Pritunl description: Pritunl background_color: \"#737373\" features: bot_user: display_name: Pritunl always_online: false slash_commands: - command: /pritunl description: Pritunl should_escape: false ## Replace the URL with the actual endpoint later after Serverless backend deployment. url: https://url-id.lambda-url.us-east-1.on.aws/ oauth_config: scopes: bot: - commands - users:read - users:read.email settings: org_deploy_enabled: false socket_mode_enabled: false token_rotation_enabled: false Once fill-in and without syntax or definition errors, proceed to next step. Step 3: Review summary &amp; create your app Based on the YAML manifest from our previous step, inspect the OAuth and Features that suit our requirements, and finalize the app creation steps by clicking the Create button. Improve App Visual Identity (Optional) For our application to have a unique visual identity from the rest of our apps, we can change the app icon. From the Pritunl app, go to -&gt; Settings -&gt; Basic Information -&gt; App Credentials -&gt; Display Information. Download the Pritunl Icon and, upload it to the App icon &amp; Preview Prepare the Slack Credentials We only need the Signing Secret and Bot Token. Then steps on how to obtain these. Getting the Signing Secret From the Pritunl app, go to -&gt; Settings -&gt; Basic Information -&gt; App Credentials. Then, click the Show button in the Signing Secret field to suppress the information and copy it for our Serverless backend deployment. Getting the Bot Token From the Pritunl app, go to -&gt; Settings -&gt; Basic Information -&gt; Install App. Then on the Install App to Your Team page, click the Install to Workspace. Review the app requesting permission to access our workspace, then click Allow. Once installed in our workspace, the field Bot User OAuth Token shows this will be our Bot Token, which we copy for our Serverless backend deployment. Deploy the Serverless Backend Prepare the Pritunl Credentials Before proceeding to Serverless backend deployment, also prepare the Pritunl credentials. From the Pritunl Dashboard (Base URL: https://vpn.domain.tld/), go to -&gt; Administrators -&gt; Select an Administrator -&gt; then tick the Enable Token Authentication. Copy the Pritunl API Token and API Secret. Tooling Requirements Install the AWS SAM CLI Make sure you have the latest AWS SAM CLI installed in your system. Serverless Backend Deployment We will use the GitHub repository Pritunl Slack App Slash Commands application as our backend for the Slack application. Deploy to AWS Lambda Figure 2: Pritunl Slack Slash Commands Serverless Backend Deployment Recorded with asciinema asciinema Clone the Serverless Backend git clone https://github.com/nathanielvarona/pritunl-slack-app.git cd pritunl-slack-app Deploy using AWS SAM Make sure you have AWS SAM CLI installed. Load the Credentials as Environment Variables export PRITUNL_BASE_URL=\"https://vpn.domain.tld/\" export PRITUNL_API_SECRET=\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\" export PRITUNL_API_TOKEN=\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\" export SLACK_SIGNING_SECRET=\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\" export SLACK_BOT_TOKEN=\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\" Build the Serverless Application The flag --use-container only works if Docker is installed. This method prevents failing builds and packaging issues and promotes the highest runtime compatibility on the serverless environment once deployed. sam build --use-container --no-cached Show Stdout Starting Build inside a container Building codeuri: .../pritunl-slack-app/pritunl_slack_app/function runtime: python3.10 metadata: {} architecture: x86_64 functions: PritunlSlackFunction Fetching public.ecr.aws/sam/build-python3.10:latest-x86_64 Docker container image...... Mounting .../pritunl-slack-app/pritunl_slack_app/function as /tmp/samcli/source:ro,delegated, inside runtime container Running PythonPipBuilder:ResolveDependencies Running PythonPipBuilder:CopySource Build Succeeded Built Artifacts : .aws-sam/build Built Template : .aws-sam/build/template.yaml Commands you can use next ========================= [*] Validate SAM template: sam validate [*] Invoke Function: sam local invoke [*] Test Function in the Cloud: sam sync --stack-name --watch [*] Deploy: sam deploy --guided Lets deploy the application The flag --no-confirm-changeset will automatically deploy the application without reviews. sam deploy --no-confirm-changeset --parameter-overrides \"\\ PritunlBaseUrl=${PRITUNL_BASE_URL} \\ PritunlApiSecret=${PRITUNL_API_SECRET} \\ PritunlApiToken=${PRITUNL_API_TOKEN} \\ SlackSigningSecret=${SLACK_SIGNING_SECRET} \\ SlackBotToken=${SLACK_BOT_TOKEN}\" Show Stdout Managed S3 bucket: aws-sam-cli-managed-default-samclisourcebucket-XXXXXXXXXXXXX A different default S3 bucket can be set in samconfig.toml Or by specifying --s3-bucket explicitly. Uploading to pritunl-slack-app/285144b7022df545f09fb472228be5a9 1073 / 1073 (100.00%) Uploading to pritunl-slack-app/76f170eb0196cbb12a272dfde42894c7 899 / 899 (100.00%) Uploading to pritunl-slack-app/1ba998885207ab33f89be0e16954258a 1104939 / 1104939 (100.00%) Deploying with following values =============================== Stack name : pritunl-slack-app Region : us-east-1 Confirm changeset : False Disable rollback : False Deployment s3 bucket : aws-sam-cli-managed-default-samclisourcebucket-XXXXXXXXXXXXX Capabilities : [\"CAPABILITY_IAM\"] Parameter overrides : {\"PritunlBaseUrl\": \"*****\", \"PritunlApiSecret\": \"*****\", \"PritunlApiToken\": \"*****\", \"SlackSigningSecret\": \"*****\", \"SlackBotToken\": \"*****\"} Signing Profiles : {} Initiating deployment ===================== Uploading to pritunl-slack-app/c1d1651005d8166da9b4e6fd66f52f6b.template 5546 / 5546 (100.00%) Waiting for changeset to be created.. CloudFormation stack changeset --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- Operation LogicalResourceId ResourceType Replacement --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- + Add AWSPritunlBaseUrl AWS::SecretsManager::Secret N/A + Add AWSSecretPritunlApiSecret AWS::SecretsManager::Secret N/A + Add AWSSecretPritunlApiToken AWS::SecretsManager::Secret N/A + Add AWSSecretSlackBotToken AWS::SecretsManager::Secret N/A + Add AWSSecretSlackSigningSecret AWS::SecretsManager::Secret N/A + Add PritunlSlackFunctionRole AWS::IAM::Role N/A + Add PritunlSlackFunctionUrl AWS::Lambda::Url N/A + Add PritunlSlackFunction AWS::Lambda::Function N/A + Add PritunlSlackUrlFunctionPermissions AWS::Lambda::Permission N/A --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- Changeset created successfully. arn:aws:cloudformation:us-east-1:############:changeSet/samcli-deploy1682663457/a848f39c-418b-47d9-8227-f6aa79ae2fa7 2023-04-28 14:31:07 - Waiting for stack create/update to complete CloudFormation events from stack operations (refresh every 5.0 seconds) --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ResourceStatus ResourceType LogicalResourceId ResourceStatusReason --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- CREATE_IN_PROGRESS AWS::CloudFormation::Stack pritunl-slack-app User Initiated CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSSecretSlackBotToken - CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSSecretSlackSigningSecret - CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSPritunlBaseUrl - CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSSecretPritunlApiToken - CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSSecretPritunlApiSecret - CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSSecretSlackSigningSecret Resource creation Initiated CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSSecretSlackBotToken Resource creation Initiated CREATE_COMPLETE AWS::SecretsManager::Secret AWSSecretSlackSigningSecret - CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSPritunlBaseUrl Resource creation Initiated CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSSecretPritunlApiSecret Resource creation Initiated CREATE_COMPLETE AWS::SecretsManager::Secret AWSSecretSlackBotToken - CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSSecretPritunlApiToken Resource creation Initiated CREATE_COMPLETE AWS::SecretsManager::Secret AWSSecretPritunlApiSecret - CREATE_COMPLETE AWS::SecretsManager::Secret AWSPritunlBaseUrl - CREATE_COMPLETE AWS::SecretsManager::Secret AWSSecretPritunlApiToken - CREATE_IN_PROGRESS AWS::IAM::Role PritunlSlackFunctionRole - CREATE_IN_PROGRESS AWS::IAM::Role PritunlSlackFunctionRole Resource creation Initiated CREATE_COMPLETE AWS::IAM::Role PritunlSlackFunctionRole - CREATE_IN_PROGRESS AWS::Lambda::Function PritunlSlackFunction - CREATE_IN_PROGRESS AWS::Lambda::Function PritunlSlackFunction Resource creation Initiated CREATE_COMPLETE AWS::Lambda::Function PritunlSlackFunction - CREATE_IN_PROGRESS AWS::Lambda::Permission PritunlSlackUrlFunctionPermissions - CREATE_IN_PROGRESS AWS::Lambda::Url PritunlSlackFunctionUrl - CREATE_IN_PROGRESS AWS::Lambda::Permission PritunlSlackUrlFunctionPermissions Resource creation Initiated CREATE_IN_PROGRESS AWS::Lambda::Url PritunlSlackFunctionUrl Resource creation Initiated CREATE_COMPLETE AWS::Lambda::Url PritunlSlackFunctionUrl - CREATE_COMPLETE AWS::Lambda::Permission PritunlSlackUrlFunctionPermissions - CREATE_COMPLETE AWS::CloudFormation::Stack pritunl-slack-app - --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- CloudFormation outputs from deployed stack --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- Outputs --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- Key PritunlSlackFunction Description Pritunl Slack App Lambda Function ARN Value arn:aws:lambda:us-east-1:############:function:pritunl-slack-app-PritunlSlackFunction-hae24jz29SIN Key PritunlSlackFunctionUrl Description Pritunl Slack App Lambda Function URL Value https://5lxvqp66eussnx4egwg5hz7dme0vbend.lambda-url.us-east-1.on.aws/ Key PritunlSlackFunctionIamRole Description Implicit IAM Role created for Pritunl Slack App function Value arn:aws:iam::############:role/pritunl-slack-app-PritunlSlackFunctionRole-XGLNKCQZS3H5 --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- Successfully created/updated stack - pritunl-slack-app in us-east-1 Modify our Slack Slash Commands configuration. Copy the value of PritunlSlackFunctionUrl from our sam deploy outputs, such as the URL https://5lxvqp66eussnx4egwg5hz7dme0vbend.lambda-url.us-east-1.on.aws/. Then modify our Slack Slash Commands Manifest configuration. From the Pritunl app, go to -&gt; Features -&gt; App Manifest -&gt; YAML. features: slash_commands: - url: https://5lxvqp66eussnx4egwg5hz7dme0vbend.lambda-url.us-east-1.on.aws/ Modify and Save Changes. And we are done! We now have a working Pritunl Slack Application, as shown in the Quick Demo. Other Methods of Deployment Lambda Functions Using Docker Image as a Package Type Only requires few changes for our SAM template.yaml to work with Docker Image Patch the SAM Template Apply the patch file template.yaml.docker-image.patch for our template.yaml using git. git apply ./template.yaml.docker-image.patch Build using SAM with extra Parameters Docker requires extra build arguments to pass the AWS Credentials to download the AWS Parameter and Secrets Lambda extension at the build stage. sam build --use-container --no-cached --parameter-overrides \"\\ AwsAccessKeyId=${AWS_ACCESS_KEY_ID} \\ AwsSecretAccessKey=${AWS_SECRET_ACCESS_KEY}\" Then Deploy The same way as how the Zip Package Type deploys. sam deploy --no-confirm-changeset --parameter-overrides \"\\ PritunlBaseUrl=${PRITUNL_BASE_URL} \\ PritunlApiSecret=${PRITUNL_API_SECRET} \\ PritunlApiToken=${PRITUNL_API_TOKEN} \\ SlackSigningSecret=${SLACK_SIGNING_SECRET} \\ SlackBotToken=${SLACK_BOT_TOKEN}\" Kubernetes Cluster with Helm Package Manager If you are in Kubernetes Cluster and highly reliant on Helm Package Manager, please consider checking the project I also created, the Pritunl Slack App Helm Chart." }, { "title": "Managing Enterprise VPN using Pritunl API CLI", "url": "/posts/managing-enterprise-vpn-using-pritunl-api-cli/", "categories": "Pritunl, Enterprise VPN", "tags": "Python Library, API Client, CLI Tool, Pritunl VPN, OpenVPN, WireGuard", "date": "2023-04-18 00:00:00 +0800", "content": "Introduction When you are in the advanced field of system administration, you always think, “Is there a CLI feature for this?” in a scenario where simple tasks like adding or modifying having a repeating process are relatively less attractive throughout the period. With the help of the Command line interface and mild scripting, we can accomplish primary things in terms of automating simple repetitive tasks. In this post, we can manage an enterprise VPN using the Pritunl API CLI, such as creating, retrieving, and updating users and a few other CLI features. Quick Demo Recorded with asciinema asciinema Installation Pritunl API CLI is already part of the Pritunl API Client for Python; to enable it, we all need to allow extra CLI during the PIP installation. The PIP extra cli will install the necessary libraries for our CLI feature. Install via PyPI Package pip install pritunl-api[cli] The CLI will automatically be available in your distribution $PATH. Try to validate that the CLI distribution is accessible by invoking the command. pritunl-api-cli --help Usage: pritunl-api-cli [OPTIONS] COMMAND [ARGS]... Pritunl API CLI Options: --version Show the version and exit. --help Show this message and exit. Commands: api user pritunl-api-cli --version pritunl-api-cli, version x.x.x Configuration API Endpoint and Credentials Setup Set the Pritunl API CLI environment variables. export PRITUNL_BASE_URL=\"https://vpn.domain.tld/\" export PRITUNL_API_TOKEN=\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\" export PRITUNL_API_SECRET=\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\" Test the connection to see if the API endpoint and credentials work correctly. pritunl-api-cli api status { \"org_count\": 1, \"users_online\": 0, \"user_count\": 0, \"servers_online\": 1, \"server_count\": 1, \"hosts_online\": 1, \"host_count\": 1, \"server_version\": \"1.30.3354.99\", \"current_host\": \"XXXXXXXXXXXXXXXXXXXXXX\", \"public_ip\": \"###.###.###.###\", \"local_networks\": [ \"172.31.80.0/20\" ], \"notification\": \"\" } CLI Usage User Feature pritunl-api-cli user Usage: pritunl-api-cli user [OPTIONS] COMMAND [ARGS]... Options: --help Show this message and exit. Commands: create delete get update Create User pritunl-api-cli user create Usage: pritunl-api-cli user create [OPTIONS] Pritunl Create User Options: --org-name TEXT --user-name TEXT --user-email TEXT --pin TEXT --yubikey-id TEXT --from-csv PATH --help Show this message and exit. Create a Single User pritunl-api-cli user create \\ --org-name pritunl-dev \\ --user-name john.doe \\ --user-email john.doe@domain.tld Create a sets of User from CSV file pritunl-api-cli user create \\ --from-csv ./users.csv Get User pritunl-api-cli user get Usage: pritunl-api-cli user get [OPTIONS] Pritunl Get User Options: --org-name TEXT --user-name TEXT --all-users --show-advanced-details --help Show this message and exit. Get a Single User pritunl-api-cli user get \\ --org-name pritunl-dev \\ --user-name john.doe Showing the advanced details of a user in JSON output. pritunl-api-cli user get \\ --org-name pritunl-dev \\ --user-name john.doe \\ --show-advanced-details Get Users from an Organization pritunl-api-cli user get \\ --org-name pritunl-dev \\ --all-users Showing the advanced details of a users in JSON output. pritunl-api-cli user get \\ --org-name pritunl-dev \\ --all-users \\ --show-advanced-details Update User pritunl-api-cli user update Usage: pritunl-api-cli user update [OPTIONS] Pritunl Update User Options: --org-name TEXT --user-name TEXT --pin TEXT --yubikey-id TEXT --disable / --enable --help Show this message and exit. Update a User for a New PIN pritunl-api-cli user update \\ --org-name pritunl-dev \\ --user-name john.doe \\ --pin 123456 Disable a User pritunl-api-cli user update \\ --org-name pritunl-dev \\ --user-name john.doe \\ --disable Enable a User pritunl-api-cli user update \\ --org-name pritunl-dev \\ --user-name john.doe \\ --enable Delete User pritunl-api-cli user delete Usage: pritunl-api-cli user delete [OPTIONS] Pritunl Delete User Options: --org-name TEXT --user-name TEXT --help Show this message and exit. Delete a User pritunl-api-cli user delete \\ --org-name pritunl-dev \\ --user-name john.doe Connection and Testing Pritunl Client Install the Pritunl Client for our Pritunl API CLI created users and the keys it generated. Pritunl Client CLI The pritunl-client package is available when installing the Pritunl Client Add a Profile pritunl-client add pritunl://vpn.domain.tld/ku/8u2KK6rZ List of Profiles pritunl-client list Start a Connection pritunl-client start zmza0w2jbqidtp5f --mode wg Stop a Connection pritunl-client stop zmza0w2jbqidtp5f Delete a Profile pritunl-client delete zmza0w2jbqidtp5f Validate Connection This a neat and quick way to test if your connection routes to your Local ISP or in the VPN Cloud Vendor. curl -s ipinfo.io/`curl -s ifconfig.me` | jq" }, { "title": "Managing AWS IAM Identity Center Multi-Account Permissions using Terraform and GitHub Actions", "url": "/posts/managing-aws-iam-identity-center-multi-account-permissions-using-terraform-and-github-actions/", "categories": "AWS, IAM Identity Center", "tags": "Amazon Web Services (AWS), Single Sign-On (SSO), AWS IAM Identity Center", "date": "2023-03-03 00:00:00 +0800", "content": "Introduction Maintaining accounts with Terraform ensures a single source of truth about what changes we made for our principals and recommended policies based on organization guidelines. We can also structure and manage the changes for our IAM Identity Center Multi-account Permission declaratively with the help of Hashicorp Configuration Language (HCL). Either a long-time or newly hired operations engineer can change quickly. Quick Demo Recorded with asciinema asciinema Requirements AWS Organization Ensure we have at least two AWS Organization Accounts in a different environment. AWS Organization Account Description Operations Management Our main AWS Account where we manage our AWS Organization Accounts. Development The Account for Development, QA, and Testing. Production The Account for Production Workloads. IAM Identity Center Users Display Name User Name Group Name John Doe johndoe@domain.tld administrator Sarah Jane sarahjane@domain.tld operations Marcello Kelley marcellokelley@domain.tld developer Miliana Smith milianasmith@domain.tld developer Antonia Morris antoniamorris@domain.tld &lt;NO GROUP&gt; A user with &lt;NO GROUP&gt; could be independently set or under other groups, such as qualityassurance, or a combination of any existing groups in our user’s table. Download and Install Tooling Softwares Instead of using Vanilla Terraform, we will use a Terraform Framework called Terraspace. Terraspace helps us organize the resources by stacks, keeping them organized and manageable at the same time. Terraform Terraspace Git AWS IAM Account Create an AWS IAM Account with Programmatic Access having the following managed permissions policies attached. AmazonS3FullAccess - Provides full access to all buckets. AmazonDynamoDBFullAccess - Provides full access to Amazon DynamoDB. IAMFullAccess - Provides full access to IAM. AWSSSOMasterAccountAdministrator - Provides access within AWS SSO to manage AWS Organizations master and member accounts and cloud application. Create an AWS IAM for our Terraform aws iam create-user --user-name provisioner # { # \"User\": { # \"Path\": \"/\", # \"UserName\": \"provisioner\", # \"UserId\": \"XXXXXXXXXXXXXXXXXXXX\", # \"Arn\": \"arn:aws:iam::&lt; AWS ACCOUNT ID &gt;:user/provisioner\", # \"CreateDate\": \"2023-02-23T11:25:55+00:00\" # } # } aws iam create-access-key --user-name provisioner # { # \"AccessKey\": { # \"UserName\": \"provisioner\", # \"AccessKeyId\": \"&lt; AWS_ACCESS_KEY_ID &gt;\", # \"Status\": \"Active\", # \"SecretAccessKey\": \"&lt; AWS_SECRET_ACCESS_KEY &gt;\", # \"CreateDate\": \"2023-02-23T11:31:51+00:00\" # } # } aws iam attach-user-policy --user-name provisioner \\ --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess aws iam attach-user-policy --user-name provisioner \\ --policy-arn arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess aws iam attach-user-policy --user-name provisioner \\ --policy-arn arn:aws:iam::aws:policy/AWSSSODirectoryAdministrator aws iam attach-user-policy --user-name provisioner \\ --policy-arn arn:aws:iam::aws:policy/IAMFullAccess aws iam list-attached-user-policies --user-name provisioner # { # \"AttachedPolicies\": [ # { # \"PolicyName\": \"IAMFullAccess\", # \"PolicyArn\": \"arn:aws:iam::aws:policy/IAMFullAccess\" # }, # { # \"PolicyName\": \"AWSSSOMasterAccountAdministrator\", # \"PolicyArn\": \"arn:aws:iam::aws:policy/AWSSSOMasterAccountAdministrator\" # }, # { # \"PolicyName\": \"AmazonDynamoDBFullAccess\", # \"PolicyArn\": \"arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess\" # }, # { # \"PolicyName\": \"AmazonS3FullAccess\", # \"PolicyArn\": \"arn:aws:iam::aws:policy/AmazonS3FullAccess\" # } # ] # } Load the AWS IAM Credentials to our System Profile aws configure --profile provisioner # AWS Access Key ID [None]: &lt; AWS_ACCESS_KEY_ID &gt; # AWS Secret Access Key [None]: &lt; AWS_SECRET_ACCESS_KEY &gt; # Default region name [None]: us-east-1 # Default output format [None]: json export AWS_PROFILE=provisioner aws sts get-caller-identity # { # \"UserId\": \"XXXXXXXXXXXXXXXXXXXX\", # \"Account\": \"&lt; AWS ACCOUNT ID &gt;\", # \"Arn\": \"arn:aws:iam::&lt; AWS ACCOUNT ID &gt;:user/provisioner\" # } Our AWS IAM User for Terraform provisioner is now ready to use. Multi-Account Permissions Project Prepare the Terraform Project Initialized a Terraform Project using Terraspace Framework Please create a new project where our Infrastructure is a Code definition for Terraform. terraspace new project aws-iam-ic-multi-account-permissions-example --plugin aws cd aws-iam-ic-multi-account-permissions-example # Makes sure we have the pregenerated files listed. tree -L 2 # . # ├── Gemfile # ├── Gemfile.lock # ├── README.md # ├── Terrafile # ├── app # │   ├── modules # │   └── stacks # └── config # ├── app.rb # └── terraform Prepare the Modules To reduce the IaC bloating and maintains the simplicity, we will be using a reusable module from CloudPosse. Install the SSO Module echo -e 'mod \"sso\", source: \"cloudposse/sso/aws\", version: \"0.7.1\"' &gt;&gt; Terrafile terraspace bundle Terraspace Stack for the Permission Sets terraspace new stack permission-sets Terraspace Stacks for our AWS Accounts terraspace new stack operations terraspace new stack development terraspace new stack production Download the Cloudposse Modules Context File ls ./app/stacks/ | xargs -I {} \\ curl -sL https://raw.githubusercontent.com/cloudposse/terraform-null-label/master/exports/context.tf \\ -o ./app/stacks/{}/context.tf Create a Terraform variable files to identify our sources on AWS Console Cloudposse context files use these variables and form proper resource naming conventions. ls ./app/stacks/ | xargs -I {} \\ sh -c 'mkdir -p ./app/stacks/{}/tfvars &amp;&amp; tee ./app/stacks/{}/tfvars/base.tfvars &lt;&lt;EOF enabled = true namespace = \"aws-sso\" name = \"aws-sso\" stage = \"&lt;%= expansion(':ENV') %&gt;\" EOF' Create a permission-sets Terraform outputs These Terraform outputs will be variables for our AWS accounts and principal assignment. tee ./app/stacks/permission-sets/outputs.tf &lt;&lt;EOF output \"permission_sets\" { description = \"Show All Permission Sets\" value = module.permission_sets.permission_sets } EOF Create a Terraform variable that binding permission-sets AWS accounts and principal assignments require permission set via outputs. ls --ignore \"permission-sets\" ./app/stacks/ | xargs -I {} \\ sh -c 'tee -a ./app/stacks/{}/tfvars/base.tfvars &lt;&lt;EOF permission_sets = &lt;%= output(\"permission-sets.permission_sets\") %&gt; EOF' Create an organization Terraform outputs Applying any Terraform action shows the output details, so we can review or validate that everything applies correctly. ls --ignore \"permission-sets\" ./app/stacks/ | xargs -I {} \\ sh -c 'tee -a ./app/stacks/{}/outputs.tf &lt;&lt;EOF output \"assignments\" { description = \"Show All Account Assignments for a Permission Set\" value = module.sso_account_assignments.assignments } EOF' Create a an variables for our Permission Sets and AWS Accounts ls --ignore \"permission-sets\" ./app/stacks/ | xargs -I {} \\ sh -c 'tee ./app/stacks/{}/variables.tf &lt;&lt;EOF variable \"permission_sets\" { } variable \"aws_account_{}\" { } EOF' Principals and Accounts Management Create a Permission Sets Resource First, create an example of an inline policy for one of our Permission Sets tee ./app/stacks/permission-sets/inline_policy_S3Access.tf &lt;&lt;EOF data \"aws_iam_policy_document\" \"inline_policy_S3Acccess\" { statement { sid = \"1\" actions = [\"*\"] resources = [ \"arn:aws:s3:::*\", ] } } EOF Permission Sets Resource Definitions tee ./app/stacks/permission-sets/main.tf &lt;&lt;EOF module \"permission_sets\" { source = \"../../modules/sso/modules/permission-sets\" context = module.this.context permission_sets = [ { name = \"AdministratorAccess\", description = \"Provides full access to AWS services and resources.\", relay_state = \"\", session_duration = \"PT12H\", tags = {}, inline_policy = \"\", policy_attachments = [ \"arn:aws:iam::aws:policy/AdministratorAccess\", ] customer_managed_policy_attachments = [] }, { name = \"PowerUserAccess\", description = \"Provides full access to AWS services and resources, but does not allow management of Users and groups.\", relay_state = \"\", session_duration = \"PT12H\", tags = {}, inline_policy = \"\", policy_attachments = [ \"arn:aws:iam::aws:policy/PowerUserAccess\", ] customer_managed_policy_attachments = [] }, { name = \"ReadOnlyAccess\" description = \"Provides read-only access to AWS services and resources.\" relay_state = \"\" session_duration = \"PT12H\" tags = {} inline_policy = data.aws_iam_policy_document.inline_policy_S3Acccess.json policy_attachments = [ \"arn:aws:iam::aws:policy/ReadOnlyAccess\", ] customer_managed_policy_attachments = [] }, ] } EOF At this point, we completed the Permission Sets stack creation and can initially apply it if we want. terraspace plan permission-sets terraspace up permission-sets Create an Accounts Assignments Resources Operations Account Resource Definitions tee ./app/stacks/operations/main.tf &lt;&lt;EOF module \"sso_account_assignments\" { source = \"../../modules/sso/modules/account-assignments\" context = module.this.context account_assignments = [ ############ ## GROUPS ## ############ { principal_name = \"administrator\" principal_type = \"GROUP\" permission_set_name = \"AdministratorAccess\" permission_set_arn = var.permission_sets[\"AdministratorAccess\"].arn account = var.aws_account_operations }, ########### ## USERS ## ########### { principal_name = \"sarahjane@domain.tld\" principal_type = \"USER\" permission_set_name = \"AdministratorAccess\" permission_set_arn = var.permission_sets[\"AdministratorAccess\"].arn account = var.aws_account_operations }, ] } EOF Plan and apply for Operations Account. terraspace plan operations terraspace up operations Development Account Resource Definitions tee ./app/stacks/development/main.tf &lt;&lt;EOF module \"sso_account_assignments\" { source = \"../../modules/sso/modules/account-assignments\" context = module.this.context account_assignments = [ ############ ## GROUPS ## ############ { principal_name = \"administrator\" principal_type = \"GROUP\" permission_set_name = \"AdministratorAccess\" permission_set_arn = var.permission_sets[\"AdministratorAccess\"].arn account = var.aws_account_development }, { principal_name = \"developer\" principal_type = \"GROUP\" permission_set_name = \"PowerUserAccess\" permission_set_arn = var.permission_sets[\"PowerUserAccess\"].arn account = var.aws_account_development }, ########### ## USERS ## ########### { principal_name = \"sarahjane@domain.tld\" principal_type = \"USER\" permission_set_name = \"PowerUserAccess\" permission_set_arn = var.permission_sets[\"PowerUserAccess\"].arn account = var.aws_account_development }, { principal_name = \"antoniamorris@domain.tld\" principal_type = \"USER\" permission_set_name = \"ReadOnlyAccess\" permission_set_arn = var.permission_sets[\"ReadOnlyAccess\"].arn account = var.aws_account_development }, ] } EOF Plan and apply for Development Account. terraspace plan development terraspace up development Production Account Resource Definition tee ./app/stacks/production/main.tf &lt;&lt;EOF module \"sso_account_assignments\" { source = \"../../modules/sso/modules/account-assignments\" context = module.this.context account_assignments = [ ############ ## GROUPS ## ############ { principal_name = \"administrator\" principal_type = \"GROUP\" permission_set_name = \"AdministratorAccess\" permission_set_arn = var.permission_sets[\"AdministratorAccess\"].arn account = var.aws_account_production }, { principal_name = \"developer\" principal_type = \"GROUP\" permission_set_name = \"ReadOnlyAccess\" permission_set_arn = var.permission_sets[\"ReadOnlyAccess\"].arn account = var.aws_account_production }, ########### ## USERS ## ########### { principal_name = \"sarahjane@domain.tld\" principal_type = \"USER\" permission_set_name = \"AdministratorAccess\" permission_set_arn = var.permission_sets[\"AdministratorAccess\"].arn account = var.aws_account_production }, ] } EOF Plan and apply for Production Account. terraspace plan production terraspace up production Stacks Final Directory Structure tree -L 3 ./app/stacks # ./app/stacks # ├── development # │   ├── context.tf # │   ├── main.tf # │   ├── outputs.tf # │   ├── tfvars # │   │   └── base.tfvars # │   └── variables.tf # ├── operations # │   ├── context.tf # │   ├── main.tf # │   ├── outputs.tf # │   ├── tfvars # │   │   └── base.tfvars # │   └── variables.tf # ├── permission-sets # │   ├── context.tf # │   ├── inline_policy_S3Access.tf # │   ├── main.tf # │   ├── outputs.tf # │   ├── tfvars # │   │   └── base.tfvars # │   └── variables.tf # └── production # ├── context.tf # ├── main.tf # ├── outputs.tf # ├── tfvars # │   └── base.tfvars # └── variables.tf Plan and Apply All Stacks We can also plan and apply at once the entire stacks, as you have seen in the Multi-Account Terraform Quick Action Demo. terraspace all plan terraspace all up Access Portal Example Scenarios Based on our Terraform resource accounts assignments. User John Doe under the administrator group. The administrator group is assigned to all accounts User Sarah Jane under the operations group. The operations group is not assigned, however we specifically assigned the user. User Marcello Kelley and Miliana Smith under the developer group. The developer group members are assigned to specific accounts with different access levels. User Antonia Morris is under no group. The user is assigned to specific account with its own access level. Automate using Github Actions GitHub Actions Workflow Create a GitHub Actions Workflow File mkdir -p ./.github/workflows &amp;&amp; tee ./.github/workflows/apply-assignments.yml &lt;&lt;EOF name: \"Apply Assignments for Accounts and Permission Sets\" on: push: branches: - main env: AWS_REGION: \"us-east-1\" AWS_ACCESS_KEY_ID: \\${{ secrets.PROVISIONER_AWS_ACCESS_KEY_ID }} AWS_SECRET_ACCESS_KEY: \\${{ secrets.PROVISIONER_AWS_SECRET_ACCESS_KEY }} AWS_ACCOUNT_ID: \\${{ secrets.OPERATIONS_AWS_ACCOUNT_ID }} TS_ENV: \"dev\" TF_VAR_aws_account_operations: \\${{ secrets.OPERATIONS_AWS_ACCOUNT_ID }} TF_VAR_aws_account_development: \\${{ secrets.DEVELOPMENT_AWS_ACCOUNT_ID }} TF_VAR_aws_account_production: \\${{ secrets.PRODUCTION_AWS_ACCOUNT_ID }} jobs: apply-assignments: runs-on: ubuntu-latest steps: - name: Checkout source uses: actions/checkout@v3 with: fetch-depth: 0 submodules: true - name: Install Terraform uses: hashicorp/setup-terraform@v2 with: terraform_wrapper: false terraform_version: 1.3.9 - name: Setup Ruby uses: ruby/setup-ruby@v1 with: ruby-version: '3.1.2' - name: Install Terraspace run: | bundle install - name: Download Terraform Modules run: | terraspace bundle - name: Terraspace All Init run: | terraspace all init -y - name: Terraspace All Up run: | terraspace all up -y - name: Upload Logs to Artifacts uses: actions/upload-artifact@v3 if: always() with: name: terraspace-logs path: ./log/* EOF Create a Secrets in our GitHub Repository PROVISIONER_AWS_ACCESS_KEY_ID PROVISIONER_AWS_SECRET_ACCESS_KEY OPERATIONS_AWS_ACCOUNT_ID DEVELOPMENT_AWS_ACCOUNT_ID PRODUCTION_AWS_ACCOUNT_ID GitHub Actions Workflow Page At this point, we can also automate the process using GitHub Actions. Without the locally installed Operations Tools, we maximized the cloud resource. Final GitHub Project Repository You can download the final and working example project repository at this link https://github.com/nathanielvarona/aws-iam-ic-multi-account-permissions-example." }, { "title": "Automatic Provisioning of AWS IAM Identity Center Users and Groups from Google Workspace Directory using SSO Sync", "url": "/posts/automatic-provisioning-of-aws-iam-identity-center-users-and-groups-from-google-workspace-directory-using-sso-sync/", "categories": "AWS, IAM Identity Center", "tags": "Google Workspace (GSuite), Google Cloud Platform (GCP), Amazon Web Services (AWS), Single Sign-On (SSO), AWS IAM Identity Center, AWS Labs, SSO Sync, AWS Cloudformation, AWS SAM, Lambda, Serverless", "date": "2023-02-11 00:00:00 +0800", "content": "Introduction AWS IAM Identity Center supports automatic provisioning from various providers, including OneLogin, Microsoft Azure Active Directory, on-premise MS Active Directory, and other supported identity providers via the System for Cross-domain Identity Management (SCIM) implementation. Google Workspace custom Security Assertion Markup Language (SAML) applications, on the other hand, don’t support automatic provisioning yet. On the other hand, AWS and Google are working with Fast Federation (FastFed) Working Group to make this feature available. In the meantime, to automate the process of synchronizing users and groups from the Google Workspace Directory to the AWS IAM Identity Center, we will use the SSOSYNC project provided by AWSLABS. In this post, we will walk you through the process of how the synchronization works and set up of SSOSYNC, running it locally for testing/debugging and deploying it as a serverless application. Identity Synchronization Diagram Created with mermaid.js Google GCP, Google Workspace, and AWS IAM IC Setup We will set up the Google GCP Service Account, Google Workspace for Domain wide delegation, and AWS IAM Identity Center SCIM Credentials as required settings and parameters for our SSO Sync. Google GCP First create an isolated GCP project only for AWS IAM Identity Center purpose. Then create or Enable the API Services for Admin SDK API. Create a Project Enable API and Services Admin SDK API Enable Admin SDK API Service Account and Client ID Create a Service Account this serves as our credentials to access the Google Workspace Directory resources. Select Service Account Credential Provide Service Account Credential Details Select Service Account Create New Key Service Account Create JSON Type Private Key A JSON file will automatically be downloaded by the browser with a filename format named aws-iam-identity-center-xxxxxx-xxxxxxxxxxxx.json. Save it in a safe place for our SSO Sync CLI tool and for serverless application to log into Google. To identify and used it easily, just rename the file aws-iam-identity-center-xxxxxx-xxxxxxxxxxxx.json to credentials.json mv aws-iam-identity-center-xxxxxx-xxxxxxxxxxxx.json credentials.json Service Account Credential Client ID Copy the 21 digit Unique ID this will be our Client ID for Google Workspace Domain Wide Delegation Google Workspace Domain Wide Delegation Domain wide delegation settings provides a linkage from our service account to access the Google Workspace Directory based on the scopes we set, for what only the SSO Sync able to obtain. Manage Domain Wide Delegation Domain Wide Delegation Add Client Add the Client ID we copied from the Service Account details form IAM and Admin (GCP) and add the list of OAuth Scopes. https://www.googleapis.com/auth/admin.directory.group.readonly https://www.googleapis.com/auth/admin.directory.group.member.readonly https://www.googleapis.com/auth/admin.directory.user.readonly AWS IAM Identity Center Automatic provisioning On AWS IAM Identity Center enable the automatic provisioning to complete the coordination from Google Workspace Directory Please take note of the SCIM credentials right after we enable them. Enable Automatic provisioning Automatic provisioning SCIM Configuration Copy the details from the SCIM endpoint to the SSOSYNC_SCIM_ENDPOINT.txt file and the Access token to the SSOSYNC_SCIM_ACCESS_TOKEN.txt file. Save these in a safe place for our SSO Sync CLI tool and for serverless application. Setup the SSO Sync (from AWS Labs) Clone and Build the SSO Sync from the Source Repository AWS Labs provided the tool to complete the process, and it serves as a pipeline for users and groups from Google Workspace Directory to AWS IAM Identity Center. The project source requires building, and a compiled distributed binary is created. Clone SSO Sync Repository Copy the source from the AWS Github repository. git clone https://github.com/awslabs/ssosync.git cd ssosync code . Build the SSO Sync Make sure you have the GO installed in your system. If you are on macOS and want to test the applications, use this command line option to build the specific binary for macOS GOOS=darwin GOARCH=amd64 make go-build GOOS=darwin GOARCH=arm64 make go-build For Linux and serverless applications, use this command line option. GOOS=linux GOARCH=amd64 make go-build Once a build is successfully run, a binary file ./ssosync is created. Manually Sync through CLI (Testing or Debugging) Using environment variables, we have provided the least required parameter for our SSO Sync. credentials.json is a file from the Service Account Create JSON Type Private Key. SSOSYNC_SCIM_ENDPOINT.txt and SSOSYNC_SCIM_ACCESS_TOKEN.txt are files from the Automatic provisioning SCIM Configuration. d-xxxxxxxxxx is the Identity store ID found in AWS Console &gt; IAM Identity Center &gt; Settings &gt; Identity source. SSOSYNC_LOG_LEVEL=debug SSOSYNC_LOG_FORMAT=text SSOSYNC_GOOGLE_CREDENTIALS=credentials.json SSOSYNC_GOOGLE_ADMIN=johndoe@domain.tld SSOSYNC_SCIM_ENDPOINT=`cat SSOSYNC_SCIM_ENDPOINT.txt` SSOSYNC_SCIM_ACCESS_TOKEN=`cat SSOSYNC_SCIM_ACCESS_TOKEN.txt` SSOSYNC_REGION=us-east-1 SSOSYNC_IDENTITY_STORE_ID=d-xxxxxxxxxx SSOSYNC_USER_MATCH= SSOSYNC_GROUP_MATCH= SSOSYNC_SYNC_METHOD=groups SSOSYNC_IGNORE_GROUPS= SSOSYNC_IGNORE_USERS= SSOSYNC_INCLUDE_GROUPS= AWS_ACCESS_KEY_ID= AWS_SECRET_ACCESS_KEY= Load the environment variables on your shell session. $ set -a &amp;&amp; source .env &amp;&amp; set +a Run the SSO Sync binary $ ./ssosync # INFO[0000] Syncing AWS users and groups from Google Workspace SAML Application # INFO[0000] syncing sync_method=groups # INFO[0000] get google groups query= # DEBU[0001] preparing list of google users and then google groups and their members # DEBU[0001] get group members from google group=administrator # DEBU[0001] get users group=administrator # DEBU[0001] get user group=administrator id=johndoe@domain.tld # INFO[0002] get existing aws groups # INFO[0003] get existing aws users # INFO[0003] get active status for aws users # INFO[0004] preparing map of user id's to user # DEBU[0004] preparing list of aws groups and their members # INFO[0004] syncing changes # DEBU[0004] deleting aws users deleted in google # DEBU[0004] updating aws users updated in google # DEBU[0004] creating aws users added in google # DEBU[0004] creating aws groups added in google # DEBU[0004] validating groups members, equals in aws and google # DEBU[0004] finding user group=administrator user=johndoe@domain.tld # DEBU[0005] checking user is in group already group=administrator user=johndoe@domain.tld # DEBU[0005] delete aws groups deleted in google # INFO[0005] sync completed :tada: As you have seen, the SSO Sync STDOUT shows the expected results. Users and Groups from Google Workspace Directory sync perfectly to our AWS IAM Identity Center. Periodically Sync through AWS SAM (Production) Build the SAM to deployable template $ sam build # Building codeuri: /path/to/awslabs/ssosync runtime: go1.x metadata: {} architecture: x86_64 functions: SSOSyncFunction # Running GoModulesBuilder:Build # Build Succeeded # Built Artifacts : .aws-sam/build # Built Template : .aws-sam/build/template.yaml # Commands you can use next # ========================= # [*] Validate SAM template: sam validate # [*] Invoke Function: sam local invoke # [*] Test Function in the Cloud: sam sync --stack-name --watch # [*] Deploy: sam deploy --guided Deploy the SSO Sync SAM Application $ sam deploy --guided # Configuring SAM deploy # ====================== # Looking for config file [samconfig.toml] : Not found # Setting default arguments for 'sam deploy' # ========================================= # Stack Name [sam-app]: SSOSync # AWS Region [us-east-1]: # Parameter ScheduleExpression [rate(15 minutes)]: # Parameter LogLevel [warn]: # Parameter LogFormat [json]: # Parameter GoogleCredentials: # Parameter GoogleAdminEmail: # Parameter SCIMEndpointUrl: # Parameter SCIMEndpointAccessToken: # Parameter Region: # Parameter IdentityStoreID: # Parameter GoogleUserMatch []: # Parameter GoogleGroupMatch []: # Parameter IgnoreGroups []: # Parameter IgnoreUsers []: # Parameter IncludeGroups []: # Parameter SyncMethod [groups]: # #Shows you resources changes to be deployed and require a 'Y' to initiate deploy # Confirm changes before deploy [y/N]: # #SAM needs permission to be able to create roles to connect to the resources in your template # Allow SAM CLI IAM role creation [Y/n]: # #Preserves the state of previously provisioned resources when an operation fails # Disable rollback [y/N]: # Save arguments to configuration file [Y/n]: # SAM configuration file [samconfig.toml]: # SAM configuration environment [default]: # **** TRUNCATED DETAILS **** # Deploying with following values # =============================== # Stack name : SSOSync # Region : us-east-1 # Confirm changeset : False # Disable rollback : False # Deployment s3 bucket : aws-sam-cli-managed-default-samclisourcebucket-************* # Capabilities : [\"CAPABILITY_IAM\"] # Parameter overrides : {\"ScheduleExpression\": \"rate(15 minutes)\", \"LogLevel\": \"warn\", \"LogFormat\": \"json\", \"GoogleCredentials\": \"*****\", \"GoogleAdminEmail\": \"*****\", \"SCIMEndpointUrl\": \"*****\", \"SCIMEndpointAccessToken\": \"*****\", \"Region\": \"*****\", \"IdentityStoreID\": \"*****\", \"GoogleUserMatch\": \"\", \"GoogleGroupMatch\": \"\", \"IgnoreGroups\": \"\", \"IgnoreUsers\": \"\", \"IncludeGroups\": \"\", \"SyncMethod\": \"groups\"} # Signing Profiles : {} # Initiating deployment # ===================== # File with same data already exists at SSOSync/*************.template, skipping upload # Waiting for changeset to be created.. # CloudFormation stack changeset # ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- # Operation LogicalResourceId ResourceType Replacement # ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- # + Add AWSGoogleAdminEmail AWS::SecretsManager::Secret N/A # + Add AWSGoogleCredentialsSecret AWS::SecretsManager::Secret N/A # + Add AWSIdentityStoreIDSecret AWS::SecretsManager::Secret N/A # + Add AWSRegionSecret AWS::SecretsManager::Secret N/A # + Add AWSSCIMAccessTokenSecret AWS::SecretsManager::Secret N/A # + Add AWSSCIMEndpointSecret AWS::SecretsManager::Secret N/A # + Add SSOSyncFunctionRole AWS::IAM::Role N/A # + Add SSOSyncFunctionSyncScheduledEventPermission AWS::Lambda::Permission N/A # + Add SSOSyncFunctionSyncScheduledEvent AWS::Events::Rule N/A # + Add SSOSyncFunction AWS::Lambda::Function N/A # ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- # Changeset created successfully. arn:aws:cloudformation:us-east-1:*************:changeSet/samcli-deploy*************/************* # 2023-02-13 00:52:57 - Waiting for stack create/update to complete # CloudFormation events from stack operations (refresh every 0.5 seconds) # ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- # ResourceStatus ResourceType LogicalResourceId ResourceStatusReason # ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- # CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSSCIMEndpointSecret - # CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSSCIMAccessTokenSecret - # CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSGoogleCredentialsSecret - # CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSRegionSecret - # CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSIdentityStoreIDSecret - # CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSSCIMEndpointSecret Resource creation Initiated # CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSRegionSecret Resource creation Initiated # CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSSCIMAccessTokenSecret Resource creation Initiated # CREATE_COMPLETE AWS::SecretsManager::Secret AWSSCIMEndpointSecret - # CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSIdentityStoreIDSecret Resource creation Initiated # CREATE_COMPLETE AWS::SecretsManager::Secret AWSSCIMAccessTokenSecret - # CREATE_IN_PROGRESS AWS::SecretsManager::Secret AWSGoogleAdminEmail Resource creation Initiated # CREATE_COMPLETE AWS::SecretsManager::Secret AWSRegionSecret - # CREATE_COMPLETE AWS::SecretsManager::Secret AWSIdentityStoreIDSecret - # CREATE_COMPLETE AWS::SecretsManager::Secret AWSGoogleCredentialsSecret - # CREATE_COMPLETE AWS::SecretsManager::Secret AWSGoogleAdminEmail - # CREATE_IN_PROGRESS AWS::IAM::Role SSOSyncFunctionRole - # CREATE_IN_PROGRESS AWS::IAM::Role SSOSyncFunctionRole Resource creation Initiated # CREATE_COMPLETE AWS::IAM::Role SSOSyncFunctionRole - # CREATE_IN_PROGRESS AWS::Lambda::Function SSOSyncFunction - # CREATE_IN_PROGRESS AWS::Lambda::Function SSOSyncFunction Resource creation Initiated # CREATE_COMPLETE AWS::Lambda::Function SSOSyncFunction - # CREATE_IN_PROGRESS AWS::Events::Rule SSOSyncFunctionSyncScheduledEvent - # CREATE_IN_PROGRESS AWS::Events::Rule SSOSyncFunctionSyncScheduledEvent Resource creation Initiated # CREATE_COMPLETE AWS::Events::Rule SSOSyncFunctionSyncScheduledEvent - # CREATE_IN_PROGRESS AWS::Lambda::Permission SSOSyncFunctionSyncScheduledEventPermission - # CREATE_IN_PROGRESS AWS::Lambda::Permission SSOSyncFunctionSyncScheduledEventPermission Resource creation Initiated # CREATE_COMPLETE AWS::Lambda::Permission SSOSyncFunctionSyncScheduledEventPermission - # CREATE_COMPLETE AWS::CloudFormation::Stack SSOSync - # ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- # Successfully created/updated stack - SSOSync in us-east-1 Test the SSOSync Lambda Application (Lambda Function Stack) Testing locally if deployed parameters are properly configured. $ echo '{}' | sam local invoke --event - \"SSOSyncFunction\" # Reading invoke payload from stdin (you can also pass it from file with --event) # Invoking dist/ssosync_linux_amd64_v1/ssosync (go1.x) # Local image was not found. # Removing rapid images for repo public.ecr.aws/sam/emulation-go1.x # Building image............................................................. # Using local image: public.ecr.aws/lambda/go:1-rapid-x86_64. # Mounting /path/to/awslabs/ssosync/.aws-sam/build/SSOSyncFunction as /var/task:ro,delegated inside runtime container # START RequestId: **************************** Version: $LATEST # time=\"2023-02-12T17:39:35Z\" level=info msg=\"Executing as Lambda\" # time=\"2023-02-12T17:39:38Z\" level=info msg=\"Syncing AWS users and groups from Google Workspace SAML Application\" # time=\"2023-02-12T17:39:38Z\" level=info msg=syncing sync_method=groups # time=\"2023-02-12T17:39:38Z\" level=info msg=\"get google groups\" query= # time=\"2023-02-12T17:39:39Z\" level=debug msg=\"preparing list of google users and then google groups and their members\" # time=\"2023-02-12T17:39:39Z\" level=debug msg=\"get group members from google\" group=administrator # time=\"2023-02-12T17:39:39Z\" level=debug msg=\"get users\" group=administrator # time=\"2023-02-12T17:39:39Z\" level=debug msg=\"get user\" group=administrator id=johndoe@domain.tld # time=\"2023-02-12T17:39:40Z\" level=info msg=\"get existing aws groups\" # time=\"2023-02-12T17:39:41Z\" level=info msg=\"get existing aws users\" # time=\"2023-02-12T17:39:42Z\" level=info msg=\"get active status for aws users\" # time=\"2023-02-12T17:39:43Z\" level=info msg=\"preparing map of user id's to user\" # time=\"2023-02-12T17:39:43Z\" level=debug msg=\"preparing list of aws groups and their members\" # time=\"2023-02-12T17:39:43Z\" level=info msg=\"syncing changes\" # time=\"2023-02-12T17:39:43Z\" level=debug msg=\"deleting aws users deleted in google\" # time=\"2023-02-12T17:39:43Z\" level=debug msg=\"updating aws users updated in google\" # time=\"2023-02-12T17:39:43Z\" level=debug msg=\"creating aws users added in google\" # time=\"2023-02-12T17:39:43Z\" level=debug msg=\"creating aws groups added in google\" # time=\"2023-02-12T17:39:43Z\" level=debug msg=\"validating groups members, equals in aws and google\" # time=\"2023-02-12T17:39:43Z\" level=debug msg=\"finding user\" group=administrator user=johndoe@domain.tld # time=\"2023-02-12T17:39:44Z\" level=debug msg=\"checking user is in group already\" group=administrator user=johndoe@domain.tld # time=\"2023-02-12T17:39:44Z\" level=debug msg=\"delete aws groups deleted in google\" # time=\"2023-02-12T17:39:44Z\" level=info msg=\"sync completed\" # \"Success\"END RequestId: **************************** # REPORT RequestId: ****************************\tInit Duration: 0.16 ms\tDuration: 8748.82 ms\tBilled Duration: 8749 ms\tMemory Size: 128 MB\tMax Memory Used: 128 MB Test the production deployed Lambda Application and check the rest of the events in the AWS Cloudwatch log groups application streams. $ aws lambda invoke --function-name SSOSync-SSOSyncFunction-************ --payload '{}' response.json # { # \"StatusCode\": 200, # \"ExecutedVersion\": \"$LATEST\" # } # $ cat response.json # \"Success\" :tada: Let the Lambda Application and its EventBridge periodic settings execute the syncing from the Google Workspace Directory to AWS IAM Identity Center do the rest. Other Deployment Options You can also deploy the SSO Sync Lambda Application through AWS Console using the AWS Serverless Application Repository. Just fill in the required parameters and deploy. Then Wait for the AWS Cloudformation to automate the deployment process." }, { "title": "Google Workspace as an external IdP for AWS IAM Identity Center", "url": "/posts/google-workspace-as-external-idp-for-aws-iam-identity-center/", "categories": "AWS, IAM Identity Center", "tags": "Google Workspace (GSuite), Google Cloud Platform (GCP), Amazon Web Services (AWS), Single Sign-On (SSO), AWS IAM Identity Center", "date": "2023-01-27 00:00:00 +0800", "content": "Introduction Google Workspace (formerly known as GSuite) is a typical first service for companies embracing the cloud, especially startups. Google Workspace provides out-of-the-box services like email, calendar, file storage, and user identity. Google also provides a service called Google Cloud Service (GCP) for business logic or computing workloads; however, companies prefer to use other vendor offerings. Then here comes Amazon Web Services (AWS), one of the prominent cloud computing vendors with various service offerings. The challenge is using the user identity from Google Workspace to use Amazon Web Services (AWS). In this post, we walk you through setting up the Google Workspace IdP for the AWS IAM Identity Center. Authentication Flow Diagram Created with mermaid.js How the Authentication Works A user with a Google Workspace account opens the link AWS access portal URL for an AWS Organization with AWS IAM Identity Center enabled. The user will be redirected to Google Workspace if not yet authenticated; the user will log in using the Google Workspace account. A response created if successfully logged in and sent to AWS IAM Identity Center contains SAML assertion, the Authentication, Authorization, and User Profiles. The response from AWS IAM Identity Center determines the user to use the portal, and successful login shows. The user can select the AWS Organization Account and Permission Set on the AWS user portal page. Prepare the AWS IAM Identity Center AWS Organization For initially setting AWS Account, enable or create first the AWS Organization. From the Account Menu (upper right corner of AWS Console, which appears to be your Account Name), open the Organization. If the organization successfully enabled or created, you will list your AWS Accounts; for now, we have the main account. AWS IAM Identity Center Enable the AWS IAM Identity Center. From the Services Menu (upper left corner of AWS Console, next to the AWS Logo), select Security, Identity, &amp; Compliance and open the IAM Identity Center (successor to AWS Single Sign-On) Configure the AWS IAM Identity Center Once enabled, select the Choose your identity source. Change the Identity Source By default, AWS uses the Internal Identity as the source. Choose identity source Choose the External identity provider as our new source. Configure external identity provider Download the metadata file or take note of the IdP metadata, as we will use it later on Google Workspace Custom SAML App. Let’s partially move to Google Workspace for Custom SAML App. Google Workspace Custom SAML App Add Custom SAML App From the Google Workspace Admin Console, select the Apps, then open the Web and mobile apps. Select the Add custom SAML app from the Add app menu. Google App Details Provide meaningful details for the app. Google Identity Provider Details Download the Google Workspace IdP metadata or take note of the IdP details as we will use it to complete the configuration for AWS external identity provider. Google Service Provider Details From the AWS external identity provider, downloaded IdP metadata provides the following details as our service provider. Finish the Custom SAML App Creation Skip the attribute mapping and finish the custom SAML App creation. Custom SAML App Configuration Configure the application User access. User Access Settings Change the service status ON for everyone. Let’s move back to AWS’s external identity provider configuration. Finalized the configuration for the external identity provider Provide the Google Workspace Custom SAML app downloaded IdP Metadata as our AWS IdP provider to establish trust. Confirm the configuration for the external identity provider. Review the changes, and confirm with ACCEPT to complete the change IdP source. Manage IAM Identity Center Accounts Groups and Users To test if the External IdP setup works, create groups and users based on the Google Workspace directory. Create a Group Create a User Permission Sets Create a set of permissions to serve as a role for the group of users and the policy attached to it. AWS Organizations Accounts Login to AWS Console with Google Workspace Credential AWS access portal URL https://d-xxxxxxxxxx.awsapps.com/start Google Login AWS IAM Identity AWS Management Console We now have a fully working External IdP provided by Google Workspace Directory for our AWS Users." } ]
